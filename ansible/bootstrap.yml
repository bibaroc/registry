---
- name: boot registry
  become: yes
  become_method: sudo
  hosts: all
  tasks:

    - name: create networks
      docker_network:
        name: "{{ item }}"
        state: present
      loop:
        - "{{ network_registry }}"
        - "{{ network_auth }}"
    - name: copy nginx config
      template:
        src: nginx.conf.j2
        dest: "/etc/{{ domain }}/nginx.conf"
      register: nginx_conf

    - name: start nginx
      docker_container:
        name: nginx
        image: "nginx:{{ nginx_version }}"
        state: started
        restart_policy: unless-stopped
        restart: "{{ nginx_conf.changed }}"
        ports:
         - "443:443"
        networks:
          - name: "{{ network_registry }}"
          - name: "{{ network_auth }}"
        networks_cli_compatible: no
        purge_networks: yes
        volumes:
          - /etc/letsencrypt:/etc/letsencrypt:ro
          - "/etc/{{ domain }}/nginx.conf:/etc/nginx/nginx.conf:ro"

    - name: start registry
      docker_container:
        name: registry
        image: "registry:{{ registry_version }}"
        state: started
        restart_policy: unless-stopped
        networks:
          - name: "{{ network_registry }}"
        networks_cli_compatible: no
        purge_networks: yes
        volumes:
          - "/etc/{{ domain }}/certs/:/certs:ro"
          - "/var/{{ domain }}/registry:/var/lib/registry"
        env:
          REGISTRY_HTTP_TLS_CERTIFICATE: /certs/registry.crt
          REGISTRY_HTTP_TLS_KEY: /certs/registry.key
          REGISTRY_HTTP_SECRET: "{{ registry_http_secret }}"
